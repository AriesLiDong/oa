{extend name="public@iframe:base" /}

{block name="main-content"}
<div class="card">
    <div class="card-action">
        电话账单名录
        <div style="display: inline-block;float: right">
            <button id="add" class="btn btn-primary" type="submit">添加</button>
        </div>
    </div>
    <div class="card-content">
        <div class="table-responsive">
            <table id="dt" class="table table-striped table-bordered dataTable no-footer">
            </table>
        </div>

    </div>
</div>
{/block}
{block name="javascript"}
<script>
    $(function(){
        addTable();
        $("#add").click(function(){
            //iframe层-父子操作
            layer.open({
                type: 2,
                area: ['1000px', '800px'],
                fixed: false, //不固定
                maxmin: true,
                content: 'add_phone',
                btn: ['确认', '取消'],
                yes: function(index, layero){
                    var form = $(layero).find("iframe")[0].contentWindow.document.getElementById("add-form");
                    var user_name = $(form).find("#user_name").val();
                    var telephone = $(form).find("#telephone").val();
                    var depart = $(form).find("#depart").val();
                    console.log(user_name);
                    console.log(telephone);
                    console.log(depart);
                    //do something
//                    layer.close(index); //如果设定了yes回调，需进行手工关闭
                }
            });
        });
    });

    //添加表格
    function addTable(){
        table = $('#dt').DataTable({
            "serverSide": true,
            "autoWidth": false,
            "searching": false,
            columns: [
                { "data": "id",  "title":"ID"},
                { "data": "number", "title":"电话"},
                { "data": "username", "title":"用户"},
                { "data": "service", "title":"服务商"},
                { "data": "department", "title":"部门", "defaultContent":""}

            ],
            language: {
                "lengthMenu": "每页 _MENU_ 条记录",
                "zeroRecords": "没有找到记录",
                "info": "第 _PAGE_ 页 ( 总共 _PAGES_ 页 )",
                "infoEmpty": "无记录",
                "infoFiltered": "(共 _MAX_ 条记录)",
                "search": "搜索",
                "paginate": {
                    "first": "首页",
                    "previous": "上页",
                    "next": "下页",
                    "last": "末页"
                }
            },
            "fnServerData": function ( sSource, data, fnCallback, oSettings ) {
                //封装请求参数
                var param = {};
                $.each(data,function(k,v){
                    if(v.name=='draw'){
                        param.draw = v.value;
                    }
                    if(v.name=='order'){
                        param.sort = {'name':data[1].value[v.value[0].column].data, 'dir':v.value[0].dir};
                    }
                    if(v.name=='start'){
                        param.start = v.value;
                    }
                    if(v.name=='length'){
                        param.limit = v.value;
                    }

                });
                oSettings.jqXHR = $.ajax({
                    "dataType": 'json',
                    "type": "GET",
                    "url": '{:url("search_phone")}',
                    "data": param,
                    "success": function (result) {
                        //返回数据预处理
                        $.each(result.auth_group,function(k,v){
                            v = dealData(v);
                        });
                        //封装返回数据
                        var returnData = {};
                        returnData.draw = result.draw;
                        returnData.recordsTotal = result.count;
                        returnData.recordsFiltered = result.count;
                        returnData.data = result.auth_group;
                        fnCallback(returnData);
                    }
                });
            },
        });
    }

    //数据预处理
    function dealData(v) {
        return v;
    }
</script>
{/block}

